<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guestbook Management Dashboard</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #ff0080;
            text-shadow: 0 0 10px #ff0080;
            border-bottom: 2px solid #ff0080;
            padding-bottom: 10px;
        }

        .stats {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .controls {
            background: #1a1a1a;
            border: 1px solid #ffff00;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        button {
            background: #2a2a2a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
        }

        button:hover {
            background: #00ff00;
            color: #000;
        }

        button.delete {
            color: #ff0080;
            border-color: #ff0080;
        }

        button.delete:hover {
            background: #ff0080;
            color: #000;
        }

        .message-list {
            margin-top: 20px;
        }

        .message {
            background: #1a1a1a;
            border: 1px solid #333;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            position: relative;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        .message-info {
            color: #ffff00;
        }

        .message-name {
            color: #ff0080;
            font-weight: bold;
        }

        .message-text {
            color: #00ffff;
            margin: 10px 0;
            word-wrap: break-word;
        }

        .message-meta {
            font-size: 0.8em;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error {
            background: #330000;
            border: 1px solid #ff0000;
            color: #ff0000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #003300;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            color: #ffff00;
            padding: 20px;
        }

        .filter-controls {
            margin: 20px 0;
        }

        input[type="text"] {
            background: #2a2a2a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px;
            border-radius: 3px;
            font-family: inherit;
            width: 200px;
        }

        .highlight {
            background: #ffff00;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>VirtualPirate Guestbook Management</h1>

        <div class="stats" id="stats">
            <strong>Loading statistics...</strong>
        </div>

        <div class="controls">
            <button onclick="loadMessages()">Refresh Messages</button>
            <button onclick="exportData()" style="color: #ffff00; border-color: #ffff00;">Export Data</button>
            <button onclick="confirmClearAll()" class="delete">Clear All Messages</button>
        </div>

        <div class="filter-controls">
            <label for="searchInput">Search: </label>
            <input type="text" id="searchInput" placeholder="Search messages..." onkeyup="filterMessages()">
            <button onclick="clearSearch()">Clear</button>
        </div>

        <div id="messageContainer">
            <div class="loading">Loading messages...</div>
        </div>
    </div>

    <script>
        let allMessages = [];

        async function loadMessages() {
            try {
                const response = await fetch('/guestbook.php');
                const data = await response.json();

                if (data.success) {
                    allMessages = data.messages;
                    updateStats();
                    displayMessages(allMessages);
                } else {
                    showError('Failed to load messages: ' + data.error);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            const totalMessages = allMessages.length;
            const today = new Date().toISOString().split('T')[0];
            const todayMessages = allMessages.filter(msg =>
                msg.timestamp.startsWith(today)
            ).length;

            stats.innerHTML = `
                <strong>Total Messages:</strong> ${totalMessages} |
                <strong>Today:</strong> ${todayMessages} |
                <strong>Last Updated:</strong> ${new Date().toLocaleString()}
            `;
        }

        function displayMessages(messages) {
            const container = document.getElementById('messageContainer');

            if (messages.length === 0) {
                container.innerHTML = '<div class="message">No messages found.</div>';
                return;
            }

            const messagesHtml = messages.map(message => `
                <div class="message" data-id="${message.id}">
                    <div class="message-header">
                        <div class="message-info">
                            <span class="message-name">${escapeHtml(message.name)}</span>
                        </div>
                        <button class="delete" onclick="deleteMessage('${message.id}')">Delete</button>
                    </div>
                    <div class="message-text">${escapeHtml(message.message)}</div>
                    <div class="message-meta">
                        <span>ID: ${message.id}</span>
                        <span>${new Date(message.timestamp).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = '<div class="message-list">' + messagesHtml + '</div>';
        }

        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            try {
                const response = await fetch('/guestbook.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: messageId })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Message deleted successfully');
                    loadMessages(); // Reload to update display
                } else {
                    showError('Failed to delete message: ' + data.error);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function confirmClearAll() {
            const count = allMessages.length;
            if (confirm(`Are you sure you want to delete ALL ${count} messages? This cannot be undone.`)) {
                clearAllMessages();
            }
        }

        async function clearAllMessages() {
            try {
                const response = await fetch('/guestbook.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ clear_all: true })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('All messages cleared successfully');
                    loadMessages();
                } else {
                    showError('Failed to clear messages: ' + data.error);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function filterMessages() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (!searchTerm) {
                displayMessages(allMessages);
                return;
            }

            const filtered = allMessages.filter(message =>
                message.name.toLowerCase().includes(searchTerm) ||
                message.message.toLowerCase().includes(searchTerm) ||
                message.id.toLowerCase().includes(searchTerm)
            );

            displayMessages(filtered);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            displayMessages(allMessages);
        }

        function exportData() {
            const dataStr = JSON.stringify({ messages: allMessages }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `guestbook-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            URL.revokeObjectURL(url);
            showSuccess('Data exported successfully');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="error">${escapeHtml(message)}</div>` + container.innerHTML;
            setTimeout(() => {
                const errorDiv = container.querySelector('.error');
                if (errorDiv) errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="success">${escapeHtml(message)}</div>` + container.innerHTML;
            setTimeout(() => {
                const successDiv = container.querySelector('.success');
                if (successDiv) successDiv.remove();
            }, 3000);
        }

        // Load messages on page load
        document.addEventListener('DOMContentLoaded', loadMessages);

        // Auto-refresh every 30 seconds
        setInterval(loadMessages, 30000);
    </script>
</body>
</html>